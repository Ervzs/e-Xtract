{% extends 'base.html' %}

{% block head %}
    <title>e-Xtract</title>
{% endblock %}

{% block body %}
<div id="container">
    <div id="left_cont_ext">
        <div id="videobox">
            <!-- Video feed or uploaded image will be displayed here -->
            <video id="video" autoplay style="display: none;"></video>
            <canvas id="canvas" style="display: none;"></canvas>
            <img id="videoFeed" style="max-width: 100%; display: none;" />

            <button id="startButton" onclick="startStreaming()">Start Camera</button>
            <button id="stopButton" onclick="stopStreaming()" style="display: none;">Stop Camera</button>
        </div>

        <div id="uploadSection">
            <h3>Upload E-Waste Image</h3>
            <input type="file" id="fileUpload" />
            <button id="uploadButton" onclick="uploadFile()">Upload</button>
        </div>
    </div>

    <div id="device_data">
        <h3>E-WASTE INFORMATION</h3>
        <h5>Type: </h5>
        <h5>Model: </h5>
        <h5>Required Tools:</h5>
        <h5>General Guidelines: </h5>
        <h5>Notable/Valuable Parts: </h5>
    </div>
</div>

<div id="dismantling_cont">
    <h2>DISMANTLING STEPS</h3>
    <h4>Step 1 (placeholder):</h5>
    <h6>desc</h7>
    <h4>Step 2 (placeholder):</h5>
    <h6>desc</h7>
    <h4>Step 3 (placeholder):</h5>
    <h6>desc</h7>
    <h4>Step 4 (placeholder):</h5>
    <h6>desc</h7>
    <h4>Step 5 (placeholder):</h5>
    <h6>desc</h7>
</div>

<script>
    let mediaStream = null;
    let intervalId = null;

    function startStreaming() {
        navigator.mediaDevices.getUserMedia({ video: true })
            .then(stream => {
                mediaStream = stream;
                document.getElementById("video").srcObject = stream;
                document.getElementById("video").style.display = "block";
                document.getElementById("videoFeed").style.display = "none";
                document.getElementById("startButton").style.display = "none";
                document.getElementById("stopButton").style.display = "inline-block";

                document.getElementById("videobox").style.paddingBottom = "20px";

                intervalId = setInterval(sendFrame, 1000); // Send frames every second
            })
            .catch(error => console.error("Camera access error:", error));
    }

    function stopStreaming() {
        if (mediaStream) {
            mediaStream.getTracks().forEach(track => track.stop());
            mediaStream = null;
        }
        if (intervalId) {
            clearInterval(intervalId);
            intervalId = null;
        }
        document.getElementById("video").style.display = "none";
        document.getElementById("startButton").style.display = "inline-block";
        document.getElementById("stopButton").style.display = "none";
    }

    function sendFrame() {
        let video = document.getElementById("video");
        let canvas = document.getElementById("canvas");
        let context = canvas.getContext("2d");

        canvas.width = video.videoWidth;
        canvas.height = video.videoHeight;
        context.drawImage(video, 0, 0, canvas.width, canvas.height);

        canvas.toBlob(blob => {
            let formData = new FormData();
            formData.append("frame", blob, "frame.jpg");
            fetch("{{ url_for('extract.video_feed') }}", {
                method: "POST",
                body: formData
            })
            .then(response => response.blob())
            .then(blob => {
                let url = URL.createObjectURL(blob);
                document.getElementById("videoFeed").src = url;
            })
            .catch(error => console.error("Frame send error:", error));
        }, "image/jpeg");
    }

    function uploadFile() {
        let fileInput = document.getElementById("fileUpload");
        let file = fileInput.files[0];

        if (!file) {
            alert("Please select a file to upload.");
            return;
        }

        stopStreaming(); // Stop the camera feed if it's running

        // Disable the upload button while processing
        document.getElementById("uploadButton").disabled = true;

        let formData = new FormData();
        formData.append("file", file);

        fetch("{{ url_for('extract.process_image') }}", {
            method: "POST",
            body: formData
        })
        .then(response => response.json()) // Parse the JSON response
        .then(data => {
            document.getElementById("uploadButton").disabled = false;

            let imgElement = document.getElementById("videoFeed");

            // convert the image string back to bytes
            let imageBytes = new Uint8Array(data.device_image.split("").map(c => c.charCodeAt(0))); 

            // create a blob from the image bytes and display it
            let blob = new Blob ([imageBytes], {type: "image/jpeg"});
            imgElement.src = URL.createObjectURL(blob); 
            imgElement.style.display = "block";

            // Display the detected object type under "Type"
            let deviceType = document.querySelector("#device_data h5:nth-of-type(1)"); // Get the first <h5> element in device_data
            if (data.device_type) {
                deviceType.textContent = "Type: " + data.device_type;
            } else {
                deviceType.textContent = "Type: N/A";
            }

            // Display the detected object model under "Model" ####!di pa nagamit!####
            let deviceModel = document.querySelector("#device_data h5:nth-of-type(2)"); // Get the second <h5> element in device_data
            if (data.device_model) {
                deviceModel.textContent = "Model: " + data.device_model;
            } else {
                deviceModel.textContent = "Model: N/A";
            }
        })
        .catch(error => {
            document.getElementById("uploadButton").disabled = false;
            console.error("Error processing image:", error);
        });
    }
</script>

{% endblock %}